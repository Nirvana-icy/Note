[è´å£³iOS Appå†·å¯åŠ¨ä¼˜åŒ–](https://ppt.infoq.cn/slide/show?cid=86&pid=3423)

[è„‰è„‰iOSå¦‚ä½•å¯åŠ¨ç§’å¼€](https://mp.weixin.qq.com/s/oUApkX3lpVTga0cEvqLlHQ)

[Trip.com APP å¯åŠ¨ä¼˜åŒ–å®žè·µ](https://mp.weixin.qq.com/s/smWjs2X8HWvcvKW_DSXYJA)

### [å¯åŠ¨ä¼˜åŒ–](https://juejin.cn/post/6921508850684133390)

![image](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/186f338fadad480ab914effa5971d13b~tplv-k3u1fbpfcp-zoom-1.image)

Appçš„å¯åŠ¨æ—¶é—´ä¼˜åŒ–ï¼Œä¸»è¦æ˜¯é’ˆå¯¹å†·å¯åŠ¨æ¥è¿›è¡Œä¼˜åŒ–çš„ã€‚é‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬å°±éœ€è¦äº†è§£ä¸€ä¸‹Appçš„å†·å¯åŠ¨è¿‡ç¨‹åŒ…å«å“ªäº›æ­¥éª¤ã€‚

ï¼ˆä¸€ï¼‰dyldé˜¶æ®µï¼šdyld1dynamic link editorï¼‰ï¼ŒAppleçš„åŠ¨æ€é“¾æŽ¥å™¨ï¼Œå¯ç”¨æ¥åŠ è½½Mach-Oæ–‡ä»¶ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ã€åŠ¨æ€åº“ç­‰ç­‰ï¼‰ã€‚å†·å¯åŠ¨ä¸€ä¸ªappä¹‹åŽï¼Œé¦–å…ˆæ˜¯dyldå¼€å§‹å·¥ä½œï¼Œå®ƒè´Ÿè´£ä¸¤ä»¶äº‹æƒ…ï¼š

åŠ è½½Appçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒåŒæ—¶ä¼šé€’å½’åŠ è½½æ‰€æœ‰ä¾èµ–åº“çš„åŠ¨æ€åº“ã€‚
å½“å®Œæˆå¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€åº“çš„åŠ è½½ä¹‹åŽï¼Œå°±é€šçŸ¥Runtimeè¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚


ï¼ˆäºŒï¼‰Runtimeé˜¶æ®µï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼ŒRuntimeåšäº†å¦‚ä¸‹çš„å·¥ä½œï¼š

è°ƒç”¨map_imageså‡½æ•°å¯¹å¯æ‰§è¡Œæ–‡ä»¶çš„å†…å®¹è¿›è¡Œè§£æžå’Œå¤„ç†ã€‚
åœ¨load_imageså‡½æ•°ä¸­è°ƒç”¨call_load_methodsï¼Œä»¥è°ƒç”¨æ‰€æœ‰Classå’ŒCategoryçš„+loadæ–¹æ³•ã€‚
è¿›è¡Œå„ç§objcç»“æž„çš„åˆå§‹åŒ–ï¼ˆä¾‹å¦‚objcç±»çš„æ³¨å†Œï¼Œåˆå§‹åŒ–ç±»å¯¹è±¡ç­‰ç­‰ï¼‰
è°ƒç”¨C++é™æ€åˆå§‹åŒ–å™¨ä»¥åŠè¢«_attribute_((constructor))ä¿®é¥°çš„å‡½æ•°


åˆ°æ­¤ä¸ºæ­¢ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€åº“ä¸­çš„æ‰€æœ‰æ‰€æœ‰Symbols**ï¼ˆç¬¦å·ï¼ŒåŒ…æ‹¬ Classï¼Œ Protocolï¼Œ Selectorï¼Œ IMPç­‰ç­‰ï¼‰éƒ½å·²ç»æŒ‰ç…§è§„å®šæ ¼å¼åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”è¢«runtimeæ‰€ç®¡ç†**

ï¼ˆä¸‰ï¼‰mainå‡½æ•°é˜¶æ®µ





ç›‘æŽ§  å·¥å…·   æœ€ä½³å®žè·µ

å¯¹äºŽpre-mainé˜¶æ®µï¼ŒAppleæä¾›äº†ä¸€ç§æµ‹é‡æ–¹æ³•ï¼Œåœ¨ Xcode ä¸­ Edit scheme -> Run -> Auguments å°†çŽ¯å¢ƒå˜é‡ DYLD_PRINT_STATISTICS è®¾ä¸º1 
å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥èŽ·å–æ›´è¯¦ç»†çš„æ—¶é—´ï¼Œåªéœ€å°†çŽ¯å¢ƒå˜é‡ DYLD_PRINT_STATISTICS_DETAILS è®¾ä¸º 1 å°±å¯ä»¥


Rebase : åœ¨dylibçš„åŠ è½½è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œå¼•å…¥äº†ASLR(Address Space Layout Randomization)æŠ€æœ¯å’Œä»£ç ç­¾åã€‚ç”±äºŽASLRçš„å­˜åœ¨ï¼Œé•œåƒ(Imageï¼ŒåŒ…æ‹¬å¯æ‰§è¡Œæ–‡ä»¶ã€ dylibå’Œbundle)ä¼šåœ¨éšæœºçš„åœ°å€ä¸ŠåŠ è½½ï¼Œå’Œä¹‹å‰æŒ‡é’ˆæŒ‡å‘çš„åœ°å€(preferred_address)ä¼šæœ‰ ä¸€ä¸ªåå·®(slide)ï¼Œdyldéœ€è¦ä¿®æ­£è¿™ä¸ªåå·®ï¼Œæ¥æŒ‡å‘æ­£ç¡®çš„åœ°å€ã€‚

bind: Rebaseåœ¨å‰ï¼ŒBindåœ¨åŽï¼ŒRebaseåšçš„æ˜¯å°†é•œåƒè¯»å…¥å†…å­˜ï¼Œä¿®æ­£é•œåƒå†…éƒ¨çš„æŒ‡é’ˆï¼Œæ€§èƒ½æ¶ˆè€—ä¸»è¦åœ¨IOã€‚Bindåšçš„æ˜¯æŸ¥è¯¢ç¬¦å·è¡¨ï¼Œè®¾ç½®æŒ‡å‘é•œåƒå¤–éƒ¨çš„æŒ‡é’ˆï¼Œæ€§èƒ½æ¶ˆè€—ä¸»è¦åœ¨CPUè®¡ç®—ã€‚




```mermaid
sequenceDiagram
    participant app_did_launch
    participant root_on_load
    participant view_appear
    participant free_time
    
   app_did_launch->>root_on_load: 0
   root_on_load->>view_appear: 0
   view_appear->>free_time: 0
```
 <!-- ImagePicker->>Memory: 0. Take photo get UIImage
    loop PNGData Convert
        Memory->>Memory: 1. UIImage to PNGData(slow ðŸŒðŸŒðŸŒðŸŒðŸŒðŸŒ )
    end -->

https://b.geekbang.org/article/408339